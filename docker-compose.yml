version: "3.8"

services:
  hub:
    build: ./hub
    container_name: recon-hub
    restart: unless-stopped

    # Needed for RTL-SDR access from inside container
    privileged: true
    volumes:
      - /dev/bus/usb:/dev/bus/usb

    environment:
      # Base ports for IQ and control sockets
      - IQ_BASE_PORT=5550
      - CTL_BASE_PORT=6000

      # Max number of SDRs to probe (indices 0..MAX_SDRS-1)
      - MAX_SDRS=8

      # How long (seconds) with no IQ data before considering dormant
      - MONITOR_DORMANT_SEC=10

    ports:
      - "8080:8080"              # Web GUI
      # A small range of IQ ports (up to 8 SDRs -> 5550–5557)
      - "5550-5557:5550-5557"
      # A small range of control ports (6000–6007)
      - "6000-6007:6000-6007"

  fft-viewer:
    build: ./tools/fft-viewer
    depends_on:
      - hub
    ports:
      - "8090:8090"

  demod:
    build:
      context: ./tools/demod
    container_name: recon-demod
    environment:
      - HUB_URL=http://hub:8080
      - HUB_HOST=hub
      - DEMOD_PORT=8100
    depends_on:
      - hub
    ports:
      - "8100:8100"

  rtlfm:
    build:
      context: ./tools/rtlfm
      dockerfile: Dockerfile
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    devices:
      - "/dev/bus/usb:/dev/bus/usb"
      - "/dev/snd:/dev/snd"
    volumes:
    - "/sys/bus/usb:/sys/bus/usb"
    - "/home/pi/stt_models:/opt/models"    
    - "/home/pi/recon-kit-data:/opt/data"

  gps:
    build: ./tools/gps
    container_name: recon-gps
    restart: unless-stopped
    # Give container access to the Pi UART
    devices:
      - "/dev/serial0:/dev/serial0"
    environment:
      - UART_DEV=/dev/serial0
      - UART_BAUD=9600
      - HTTP_PORT=8085
      - NMEA_TCP_PORT=10110
      - STALE_SEC=5
      - WRITE_JSON=/run/gps/position.json
      - DEFAULT_LAT=41.39
      - DEFAULT_LON=-71.58
      - DEFAULT_ALT=0.0
    ports:
      - "8085:8085"     # GPS web UI + JSON/SSE
      - "10110:10110"   # Raw NMEA TCP stream

  p25:
    build: ./tools/p25
    container_name: recon-p25
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
    - ./tools/p25/config:/config
    - ./tools/p25/app.py:/opt/p25/app.py:ro 
    environment:
      - TZ=America/New_York
      # default settings; override from your "traffic controller" later
      - OP25_RX_PY=/opt/op25/op25/gr-op25_repeater/apps/rx.py
    ports:
      - "9005:9005"